<!-- NOTE: This page links to index.html, which is currently a placeholder. Final homepage will be updated later. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stablecoin LP Dashboard</title>
    <style>
        :root {
            --bg-color: #0a0a0a;
            --bg-color-lighter: #111111;
            --surface-color: #1a1a1a;
            --surface-color-alt: #141414;
            --primary-text-color: #e0e0e0;
            --secondary-text-color: #888888;
            --border-color: #2a2a2a;
            --accent-color: #666666;
            --hover-bg-color: #222222;
            --success-color: #4ade80;
            --warning-color: #fbbf24;
            --error-color: #f87171;
            --btc-color: #f7931a;
            --eth-color: #87CEEB;
            --usdc-color: #4A90E2;
            --usdt-color: #5CB85C;
            --dai-color: #D4A76A;
            --sol-color: #9945FF;
            --sui-color: #6fbcf0;
            --apr-low: #1a5f2a;
            --apr-moderate: #2d8a3e;
            --apr-good: #48bb5c;
            --apr-excellent: #4ade80;
            
            /* Teal Theme Accents */
            --util-low: #006666;
            --util-moderate: #008080;
            --util-high: #20B2AA;
            --util-excellent: #66CDAA;
            
            --section-bg: #0f0f0f;
            --section-border: #2a2a2a;
            --section-header-bg: #151515;
            --section-th-bg: #121212;
            --link-color: #999999;
            --link-color-hover: #cccccc;
            --liquidity-bar-color: hsl(180, 50%, 35%);
            --geckoterminal-color: #008080;
            --dexscreener-color: #008080;
            
            /* Section Title Color */
            --section-title-color: #008080;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            line-height: 1.5;
            min-height: 100vh;
        }

        header {
            padding: 1.25rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--bg-color-lighter);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: 1rem;
            max-width: 1920px;
            margin: 0 auto;
        }

        .header-left h1 {
            font-size: 1.6rem;
            font-weight: 600;
            color: var(--primary-text-color);
            margin-bottom: 0.4rem;
        }

        .header-left p {
            color: var(--secondary-text-color);
            font-size: 0.9rem;
        }

        .home-link {
            display: inline-block;
            color: var(--util-moderate);
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            transition: color 0.2s ease;
        }

        .home-link:hover {
            color: var(--util-high);
            text-decoration: underline;
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-status {
            font-size: 0.8rem;
            color: var(--secondary-text-color);
            text-align: right;
        }

        .header-status .pool-count {
            color: var(--success-color);
            font-weight: 600;
        }

        .header-status .network-count {
            color: var(--util-high);
            font-weight: 500;
        }

        .header-status .loading-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--warning-color);
        }

        .header-status .error-indicator {
            color: var(--error-color);
        }

        main {
            padding: 1.25rem;
            max-width: 1920px;
            margin: 0 auto;
        }

        footer {
            padding: 0.75rem 2rem;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 0.8rem;
            color: var(--secondary-text-color);
        }

        .data-sources {
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .source-gecko { color: var(--geckoterminal-color); }
        .source-dexscreener { color: var(--dexscreener-color); }

        .btn {
            background-color: #333333;
            color: #fff;
            border: 1px solid #444444;
            padding: 0.5rem 1rem;
            border-radius: 3px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .btn:hover {
            background-color: #444444;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background-color: #222222;
            color: var(--secondary-text-color);
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background-color: var(--util-moderate);
            border-color: var(--util-high);
        }

        .btn-primary:hover {
            background-color: var(--util-high);
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        #progress-container {
            width: 100%;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        #progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--geckoterminal-color), var(--util-excellent));
            border-radius: 2px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-text-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .spinner-sm {
            width: 12px;
            height: 12px;
            border-width: 1.5px;
        }

        .hidden { display: none !important; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.25rem;
            min-height: 500px;
        }

        #stablecoin-section-wrapper {
            margin-top: 1.25rem;
        }

        .pair-section {
            background-color: var(--section-bg);
            border: 1px solid var(--section-border);
            border-radius: 3px;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            max-height: 450px;
            position: relative;
        }

        .pair-section.full-width {
            grid-column: span 2;
            max-height: 380px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background-color: var(--section-header-bg);
            border-bottom: 1px solid var(--section-border);
            flex-shrink: 0;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--section-title-color);
        }

        .section-title span {
            color: inherit !important;
        }

        .pool-count {
            font-size: 0.85rem;
            font-weight: 400;
            opacity: 0.7;
        }

        .section-controls {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex-wrap: wrap;
        }

        .timeframe-toggle {
            display: flex;
            align-items: center;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 2px;
            gap: 2px;
        }

        .tf-btn {
            background-color: transparent;
            color: var(--secondary-text-color);
            border: none;
            padding: 0.3rem 0.55rem;
            border-radius: 2px;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            white-space: nowrap;
        }

        .tf-btn:hover {
            background-color: var(--hover-bg-color);
            color: var(--primary-text-color);
        }

        .tf-btn.active {
            background-color: var(--util-moderate);
            color: #fff;
        }
        
        .tf-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .section-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(10, 10, 10, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }

        .section-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .section-overlay .spinner {
            width: 28px;
            height: 28px;
            border-width: 3px;
            border-top-color: var(--util-high);
            margin-bottom: 0.75rem;
        }

        .section-overlay-text {
            font-size: 0.85rem;
            color: var(--secondary-text-color);
            text-align: center;
            padding: 0 1rem;
        }

        .section-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .table-container {
            flex: 1;
            overflow: auto;
            min-height: 0;
        }

        .pool-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            table-layout: fixed;
        }

        .pool-table th,
        .pool-table td {
            padding: 0.55rem 0.7rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            vertical-align: middle;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pool-table .col-chain { width: 80px; }
        .pool-table .col-protocol { width: 90px; }
        .pool-table .col-pool { width: 200px; min-width: 180px; }
        .pool-table .col-fee { width: 65px; }
        .pool-table .col-liquidity { width: 100px; }
        .pool-table .col-volume { width: 110px; }
        .pool-table .col-util { width: 80px; }
        .pool-table .col-apr { width: 90px; }

        .pool-table .col-liquidity,
        .pool-table .col-volume,
        .pool-table .col-util,
        .pool-table .col-apr,
        .pool-table td:nth-child(5),
        .pool-table td:nth-child(6),
        .pool-table td:nth-child(7),
        .pool-table td:nth-child(8) {
            text-align: right;
        }

        .pool-table th {
            background-color: var(--section-th-bg);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            font-size: 0.73rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--secondary-text-color);
        }

        .pool-table th:hover {
            color: var(--primary-text-color);
        }

        .pool-table th[data-sort]::after {
            content: ' ‚áÖ';
            opacity: 0.4;
            font-size: 0.65em;
        }

        .pool-table th.sort-asc::after {
            content: ' ‚Üë';
            opacity: 1;
        }

        .pool-table th.sort-desc::after {
            content: ' ‚Üì';
            opacity: 1;
        }

        .pool-table tbody tr {
            transition: background-color 0.15s ease;
        }

        .pool-table tbody tr:hover {
            background-color: var(--hover-bg-color);
        }

        .pool-table tbody tr:last-child td {
            border-bottom: none;
        }

        .pool-link,
        .explorer-link {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.15s ease;
        }

        .pool-link:hover,
        .explorer-link:hover {
            color: var(--link-color-hover);
            text-decoration: underline;
        }

        .pool-cell {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            min-width: 180px;
        }

        .pool-cell .pool-link {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pool-cell .explorer-link {
            flex-shrink: 0;
            width: 18px;
            text-align: center;
            font-size: 0.75rem;
            opacity: 0.5;
        }

        .pool-cell .explorer-link:hover {
            opacity: 1;
        }

        .token-btc { color: var(--btc-color); font-weight: 600; }
        .token-eth { color: var(--eth-color); font-weight: 600; }
        .token-usdc { color: var(--usdc-color); font-weight: 600; }
        .token-usdt { color: var(--usdt-color); font-weight: 600; }
        .token-dai { color: var(--dai-color); font-weight: 600; }
        .token-sol { color: var(--sol-color); font-weight: 600; }
        .token-stable { color: var(--primary-text-color); font-weight: 500; }
        .token-prefix { font-weight: 400; }

        .protocol-badge {
            display: inline-block;
            padding: 0.1rem 0.35rem;
            border-radius: 2px;
            font-size: 0.7rem;
            font-weight: 500;
            background-color: rgba(255, 255, 255, 0.08); 
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .fee-badge {
            display: inline-block;
            padding: 0.12rem 0.35rem;
            border-radius: 2px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--secondary-text-color);
        }

        .fee-badge.fee-low { background-color: rgba(74, 222, 128, 0.2); color: var(--success-color); }
        .fee-badge.fee-medium { background-color: rgba(251, 191, 36, 0.2); color: var(--warning-color); }
        .fee-badge.fee-high { background-color: rgba(248, 113, 113, 0.2); color: var(--error-color); }

        .liquidity-cell {
            position: relative;
            font-weight: 500;
        }

        .liquidity-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            opacity: 0.4;
            border-radius: 1px;
            z-index: 0;
            background: linear-gradient(90deg, hsl(180, 50%, 25%), hsl(180, 50%, 40%));
        }

        .liquidity-value {
            position: relative;
            z-index: 1;
        }

        .apr-value { font-weight: 600; }
        .apr-excellent { color: var(--apr-excellent); }
        .apr-good { color: var(--apr-good); }
        .apr-moderate { color: var(--apr-moderate); }
        .apr-low { color: var(--apr-low); }

        .utilization-value { font-weight: 600; }
        .utilization-excellent { color: var(--util-excellent); }
        .utilization-high { color: var(--util-high); }
        .utilization-moderate { color: var(--util-moderate); }
        .utilization-low { color: var(--util-low); }

        .no-data {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--secondary-text-color);
            font-size: 0.9rem;
        }

        .tf-indicator {
            font-size: 0.65rem;
            opacity: 0.6;
            margin-left: 0.2rem;
            display: inline-block;
            min-width: 28px;
        }

        .volume-cell, .apr-cell { white-space: nowrap; }

        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: var(--bg-color); }
        .table-container::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
        .table-container::-webkit-scrollbar-thumb:hover { background: var(--secondary-text-color); }

        #debug-section {
            margin-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            padding-top: 1rem;
        }

        .debug-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .debug-toggle {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            padding: 0.3rem 0.6rem;
            border-radius: 2px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .debug-toggle:hover {
            background-color: var(--hover-bg-color);
            color: var(--primary-text-color);
        }

        #debug-log {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            padding: 1rem;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 0.72rem;
            max-height: 280px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .log-error { color: var(--error-color); }
        .log-warn { color: var(--warning-color); }
        .log-success { color: var(--success-color); }
        .log-info { color: var(--secondary-text-color); }
        .log-gecko { color: var(--geckoterminal-color); }
        .log-dexscreener { color: var(--dexscreener-color); }

        @media (max-width: 1200px) {
            #dashboard-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            header { padding: 1rem; }
            .header-content { flex-direction: column; align-items: flex-start; }
            .header-right { align-items: flex-start; width: 100%; }
            .header-left h1 { font-size: 1.3rem; }
            main { padding: 0.75rem; }
            .section-header { flex-direction: column; align-items: flex-start; }
            .section-controls { width: 100%; justify-content: space-between; }
            .pair-section { min-height: 280px; max-height: 400px; }
            .pool-table th, .pool-table td { padding: 0.45rem 0.5rem; font-size: 0.78rem; }
            .pool-table .col-pool { min-width: 150px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-left">
                <a href="index.html" class="home-link">‚Üê Back to Home</a>
                <h1>Stablecoin LP Dashboard</h1>
                <p>High utilization stablecoin pairs. Powered by GeckoTerminal & DexScreener.</p>
            </div>
            <div class="header-right">
                <div class="header-controls">
                    <div class="header-status" id="header-status">
                        <span class="loading-indicator">
                            <span class="spinner spinner-sm"></span>
                            Initializing...
                        </span>
                    </div>
                    <button id="refresh-btn" class="btn btn-sm">Refresh Data</button>
                </div>
                <div id="last-updated" style="font-size: 0.75rem; color: var(--secondary-text-color);"></div>
            </div>
        </div>
    </header>

    <main>
        <div id="progress-container" class="hidden">
            <div id="progress-bar"></div>
        </div>
        <div id="dashboard-grid"></div>
        <div id="stablecoin-section-wrapper"></div>
        <div id="debug-section" class="hidden">
            <div class="debug-header">
                <span style="font-size: 0.75rem; color: var(--secondary-text-color);">Debug Log</span>
                <button id="clear-debug" class="debug-toggle">Clear</button>
            </div>
            <div id="debug-log"></div>
        </div>
    </main>

    <footer>
        <p>
            Always DYOR. Data displayed is for informational purposes only.
            <button id="debug-toggle" class="debug-toggle" style="margin-left: 1rem;">Toggle Debug</button>
        </p>
        <div class="data-sources">
            <span class="source-gecko">‚óè GeckoTerminal</span>
            <span class="source-dexscreener">‚óè DexScreener</span>
        </div>
    </footer>

    <script>
    (function() {
        'use strict';

        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            APIS: {
                GECKOTERMINAL: 'https://api.geckoterminal.com/api/v2',
                DEXSCREENER: 'https://api.dexscreener.com/latest/dex'
            },

            RATE_LIMITS: {
                GECKOTERMINAL: 2200,
                DEXSCREENER: 200 // 300 req/min limit -> ~200ms safety
            },

            MAX_RETRIES: 3,
            RETRY_DELAY_MS: 2000,
            TIMEOUT_MS: 15000,
            MIN_LIQUIDITY: 50000,
            MIN_VOLUME_24H: 1000,
            POOLS_PER_PAGE: 20,
            
            // SECTIONS SPECIFIC TO STABLECOINS
            SECTIONS: [
                { id: 'btc-stable', title: '<span class="token-btc">BTC</span> / Stablecoin', source: 'gecko' },
                { id: 'eth-stable', title: '<span class="token-eth">ETH</span> / Stablecoin', source: 'gecko' },
                { id: 'sol-stable', title: '<span class="token-sol">SOL</span> / Stablecoin', source: 'dexscreener', full: false },
                { id: 'stable-stable', title: 'Stablecoin Pairs', source: 'gecko', full: true }
            ],

            NETWORKS: {
                // GeckoTerminal Networks for BTC/ETH/Stable
                GECKO: ['eth', 'base', 'arbitrum', 'optimism', 'polygon_pos'],
                // DexScreener Chain for SOL
                DEXSCREENER: 'solana'
            },

            NETWORK_NAMES: {
                eth: 'Ethereum', arbitrum: 'Arbitrum', optimism: 'Optimism', base: 'Base',
                polygon_pos: 'Polygon', solana: 'Solana'
            },

            EXPLORERS: {
                eth: 'https://etherscan.io/address/',
                arbitrum: 'https://arbiscan.io/address/',
                optimism: 'https://optimistic.etherscan.io/address/',
                base: 'https://basescan.org/address/',
                polygon_pos: 'https://polygonscan.com/address/',
                solana: 'https://solscan.io/account/'
            },

            SEARCHES: {
                'btc-stable': ['WBTC USDC', 'WBTC USDT', 'cbBTC USDC', 'tBTC USDC', 'WBTC DAI', 'BTC USDC', 'BTC USDT'],
                'eth-stable': ['WETH USDC', 'WETH USDT', 'ETH USDC', 'ETH USDT', 'WETH DAI', 'ETH DAI'],
                'stable-stable': ['USDC USDT', 'USDC DAI', 'USDT DAI', 'FRAX USDC', 'LUSD USDC']
            },

            // DexScreener specific queries
            DEXSCREENER_QUERIES: ['SOL USDC', 'SOL USDT'],

            ASSETS: {
                BTC: ['btc', 'wbtc', 'cbbtc', 'tbtc', 'renbtc'],
                ETH: ['eth', 'weth', 'steth', 'wsteth', 'reth', 'cbeth'],
                SOL: ['sol', 'wsol'],
                STABLE: ['usdc', 'usdt', 'dai', 'usdbc', 'frax', 'lusd', 'usds', 'crvusd', 'tusd', 'busd', 'gusd', 'usdp', 'usdd', 'pyusd']
            },

            EXCLUDED: new Set(['btcbull', 'ethbull', 'btc2x'])
        };

        const ASSET_MAP = {};
        Object.entries(CONFIG.ASSETS).forEach(([cls, tokens]) => {
            tokens.forEach(t => ASSET_MAP[t.toLowerCase().replace(/\./g, '')] = cls);
        });

        // ============================================
        // STATE
        // ============================================
        const state = {
            pools: new Map(),
            isLoading: false,
            debugLogs: [],
            sections: {}
        };

        CONFIG.SECTIONS.forEach(s => {
            state.sections[s.id] = {
                pools: [],
                timeframe: '24h',
                sortField: 'utilization',
                sortDir: 'desc',
                isLoading: false
            };
        });

        // ============================================
        // UTILITIES
        // ============================================
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        function log(msg, type = 'info') {
            const ts = new Date().toLocaleTimeString();
            state.debugLogs.push({ ts, type, msg });
            if (state.debugLogs.length > 500) state.debugLogs = state.debugLogs.slice(-400);
            console.log(`[${ts}] [${type.toUpperCase()}] ${msg}`);
            renderDebugLog();
        }

        function renderDebugLog() {
            const el = document.getElementById('debug-log');
            if (el) {
                el.innerHTML = state.debugLogs.map(l =>
                    `<div class="log-${l.type}">[${l.ts}] ${l.msg}</div>`
                ).join('');
                el.scrollTop = el.scrollHeight;
            }
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str || '';
            return div.innerHTML;
        }

        function formatUsd(val) {
            if (!val && val !== 0) return '$0.00';
            if (val >= 1e9) return '$' + (val / 1e9).toFixed(2) + 'B';
            if (val >= 1e6) return '$' + (val / 1e6).toFixed(2) + 'M';
            if (val >= 1e3) return '$' + (val / 1e3).toFixed(1) + 'K';
            return '$' + val.toFixed(2);
        }

        function formatUtilization(util) {
            const pct = util * 100;
            if (pct >= 100) return pct.toFixed(0) + '%';
            if (pct >= 10) return pct.toFixed(1) + '%';
            return pct.toFixed(2) + '%';
        }

        function updateHeaderStatus(msg, type = 'info', loading = false) {
            const el = document.getElementById('header-status');
            if (!el) return;
            if (loading) {
                el.innerHTML = `
                    <span class="loading-indicator">
                        <span class="spinner spinner-sm"></span>
                        ${escapeHtml(msg)}
                    </span>
                `;
            } else if (type === 'error') {
                el.innerHTML = `<span class="error-indicator">${escapeHtml(msg)}</span>`;
            } else if (type === 'success') {
                const poolCount = state.pools.size;
                el.innerHTML = `
                    <span class="pool-count">${poolCount}</span> pools loaded
                `;
            } else {
                el.innerHTML = escapeHtml(msg);
            }
        }

        function updateProgress(pct) {
            const container = document.getElementById('progress-container');
            const bar = document.getElementById('progress-bar');
            if (pct > 0 && pct < 100) {
                container.classList.remove('hidden');
                bar.style.width = pct + '%';
            } else {
                container.classList.add('hidden');
                bar.style.width = '0%';
            }
        }

        // ============================================
        // TOKEN FORMATTING
        // ============================================
        function formatTokenSymbol(symbol) {
            if (!symbol) return '';
            const original = symbol.trim();
            const upper = original.toUpperCase();
            const lower = original.toLowerCase();

            if (upper === 'SOL' || upper.endsWith('SOL')) {
                const solIndex = upper.indexOf('SOL');
                const prefix = original.substring(0, solIndex).toLowerCase();
                let html = '';
                if (prefix) html += `<span class="token-prefix">${escapeHtml(prefix)}</span>`;
                html += `<span class="token-sol">SOL</span>`;
                return html;
            }
            if (upper === 'BTC') {
                 return `<span class="token-btc">BTC</span>`;
            }
            if (upper === 'ETH' || upper === 'WETH') {
                 return `<span class="token-eth">${upper}</span>`;
            }
            const normalized = lower.replace(/\./g, '');
            if (normalized === 'usdc' || normalized === 'usdce') {
                return `<span class="token-usdc">${escapeHtml(upper)}</span>`;
            }
            if (normalized === 'usdt' || normalized === 'usdtce') {
                return `<span class="token-usdt">${escapeHtml(upper)}</span>`;
            }
            if (normalized === 'dai') {
                return `<span class="token-dai">${escapeHtml(upper)}</span>`;
            }
            return `<span class="token-stable">${escapeHtml(upper)}</span>`;
        }

        function colorizePoolName(name) {
            if (!name) return '';
            const parts = name.split(/(\s*[\/\-]\s*)/);
            return parts.map(part => {
                const trimmed = part.trim();
                if (/^^[\/\-\s]+$/.test(part)) return escapeHtml(part);
                return formatTokenSymbol(trimmed);
            }).join('');
        }

        // ============================================
        // DATA SOURCES
        // ============================================
        class DataSource {
            constructor(name) {
                this.name = name;
                this.rateLimitMs = CONFIG.RATE_LIMITS.DEFAULT;
            }

            async rateLimit() {
                const now = Date.now();
                const elapsed = now - (this.lastCall || 0);
                if (elapsed < this.rateLimitMs) {
                    await sleep(this.rateLimitMs - elapsed);
                }
                this.lastCall = Date.now();
            }

            async fetchWithRetry(url) {
                await this.rateLimit();
                for (let attempt = 1; attempt <= CONFIG.MAX_RETRIES; attempt++) {
                    try {
                        const ctrl = new AbortController();
                        const timeout = setTimeout(() => ctrl.abort(), CONFIG.TIMEOUT_MS);
                        const res = await fetch(url, { signal: ctrl.signal });
                        clearTimeout(timeout);
                        if (res.status === 429) {
                            log(`[${this.name}] Rate limited. Waiting...`, 'warn');
                            await sleep(10000);
                            continue;
                        }
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        return await res.json();
                    } catch (err) {
                        log(`[${this.name}] Error (${attempt}/${CONFIG.MAX_RETRIES}): ${err.message}`, 'warn');
                        if (attempt < CONFIG.MAX_RETRIES) await sleep(CONFIG.RETRY_DELAY_MS * attempt);
                    }
                }
                return null;
            }
        }

        class GeckoTerminalSource extends DataSource {
            constructor(network) {
                super('GeckoTerminal');
                this.network = network;
                this.baseUrl = CONFIG.APIS.GECKOTERMINAL;
                this.rateLimitMs = CONFIG.RATE_LIMITS.GECKOTERMINAL;
            }

            normalizePool(raw) {
                const attr = raw.attributes;
                const rel = raw.relationships;
                if (!attr || !rel) return null;

                const liquidity = parseFloat(attr.reserve_in_usd || 0);
                const volume24h = parseFloat(attr.volume_usd?.h24 || 0);

                if (liquidity < CONFIG.MIN_LIQUIDITY || volume24h < CONFIG.MIN_VOLUME_24H) return null;

                const includedMap = {};
                if (raw.included) {
                    raw.included.forEach(item => includedMap[item.id] = item.attributes);
                }

                const getToken = (relField) => {
                    const t = rel[relField]?.data;
                    return t ? { symbol: (includedMap[t.id] || {}).symbol || '???' } : { symbol: '???' };
                };

                const t0 = getToken('base_token');
                const t1 = getToken('quote_token');
                
                // Guess Fee
                let fee = 0.003; 
                const name = attr.name.toLowerCase();
                if (name.includes('0.05%')) fee = 0.0005;
                else if (name.includes('0.01%')) fee = 0.0001;
                else if (name.includes('0.3%')) fee = 0.003;
                else if (name.includes('1%')) fee = 0.01;
                else if (name.includes('0.1%')) fee = 0.001;
                else if (name.includes('0.5%')) fee = 0.005;
                else if (name.includes('0.02%')) fee = 0.0002;
                else if (name.includes('0.04%')) fee = 0.0004;
                else if (name.includes('0.25%') || name.includes('curve')) fee = 0.0025;
                else if (name.includes('0.06%')) fee = 0.0006;

                return {
                    id: raw.id,
                    name: attr.name,
                    address: attr.address,
                    liquidity,
                    volume24h,
                    fee,
                    protocol: (includedMap[rel.dex?.data?.id] || {}).name || 'DEX',
                    token0: t0,
                    token1: t1,
                    chainId: this.network
                };
            }

            async searchPools(query) {
                const url = `${this.baseUrl}/search/pools?query=${encodeURIComponent(query)}&network=${this.network}`;
                const res = await this.fetchWithRetry(url);
                if (!res || !res.data) return [];
                return res.data.map(p => this.normalizePool(p)).filter(p => p);
            }
        }

        class DexScreenerSource extends DataSource {
            constructor() {
                super('DexScreener');
                this.baseUrl = CONFIG.APIS.DEXSCREENER;
                this.rateLimitMs = CONFIG.RATE_LIMITS.DEXSCREENER;
            }

            normalizePool(pair) {
                const liquidity = pair.liquidity?.usd || 0;
                const volume24h = pair.volume?.h24 || 0;
                
                if (liquidity < CONFIG.MIN_LIQUIDITY || volume24h < CONFIG.MIN_VOLUME_24H) return null;

                // Standard Solana Fee approx 0.25% for Raydium/Orca
                const fee = 0.0025; 

                return {
                    id: pair.pairAddress,
                    name: `${pair.baseToken.symbol} / ${pair.quoteToken.symbol}`,
                    address: pair.pairAddress,
                    liquidity,
                    volume24h,
                    fee,
                    protocol: pair.dexId || 'DEX',
                    token0: { symbol: pair.baseToken.symbol },
                    token1: { symbol: pair.quoteToken.symbol },
                    chainId: pair.chainId
                };
            }

            async searchPools(query) {
                const url = `${this.baseUrl}/search?q=${encodeURIComponent(query)}`;
                const res = await this.fetchWithRetry(url);
                if (!res || !res.pairs) return [];
                
                // Filter for Solana only
                const solPairs = res.pairs.filter(p => p.chainId === 'solana');
                return solPairs.map(p => this.normalizePool(p)).filter(p => p);
            }
        }

        // ============================================
        // APP LOGIC
        // ============================================
        function calculateMetrics(pool) {
            if (!pool) return;
            const utilization = pool.volume24h / pool.liquidity;
            // APR = (Volume * Fee) / Liquidity * 365
            const dailyFees = pool.volume24h * pool.fee;
            const apr = (dailyFees / pool.liquidity) * 365;

            pool.apr = apr;
            pool.utilization = utilization;
            
            // Add colors for UI
            if (pool.utilization >= 0.8) pool.utilClass = 'utilization-excellent';
            else if (pool.utilization >= 0.5) pool.utilClass = 'utilization-high';
            else if (pool.utilization >= 0.2) pool.utilClass = 'utilization-moderate';
            else pool.utilClass = 'utilization-low';

            if (pool.apr >= 0.5) pool.aprClass = 'apr-excellent';
            else if (pool.apr >= 0.2) pool.aprClass = 'apr-good';
            else if (pool.apr >= 0.1) pool.aprClass = 'apr-moderate';
            else pool.aprClass = 'apr-low';
            
            // Fee badge class
            if (pool.fee <= 0.001) pool.feeClass = 'fee-low';
            else if (pool.fee <= 0.003) pool.feeClass = 'fee-medium';
            else pool.feeClass = 'fee-high';
        }

        function sortPools(pools, field, dir) {
            return [...pools].sort((a, b) => {
                let valA = a[field];
                let valB = b[field];
                if (valA < valB) return dir === 'asc' ? -1 : 1;
                if (valA > valB) return dir === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function renderSection(sectionId) {
            const secState = state.sections[sectionId];
            const container = document.getElementById(`section-${sectionId}`);
            if (!container) return;

            const listEl = document.getElementById(`list-${sectionId}`);
            const overlay = document.getElementById(`overlay-${sectionId}`);
            
            // Toggle Overlay
            if (secState.isLoading) overlay.classList.add('active');
            else overlay.classList.remove('active');

            // Render Rows
            const sorted = sortPools(secState.pools, secState.sortField, secState.sortDir);
            
            listEl.innerHTML = sorted.map(pool => {
                const explorerUrl = CONFIG.EXPLORERS[pool.chainId] || '#';
                const poolNameHtml = colorizePoolName(pool.name);
                const feePct = (pool.fee * 100).toFixed(2) + '%';
                
                return `
                <tr>
                    <td class="col-chain">
                        <span style="font-size:0.75rem; opacity:0.8;">${CONFIG.NETWORK_NAMES[pool.chainId] || pool.chainId}</span>
                    </td>
                    <td class="col-protocol">
                        <span class="protocol-badge">${escapeHtml(pool.protocol)}</span>
                    </td>
                    <td class="col-pool">
                        <div class="pool-cell">
                            <span class="pool-link" title="${escapeHtml(pool.name)}">${poolNameHtml}</span>
                            <a href="${explorerUrl}${pool.address}" target="_blank" class="explorer-link">üîç</a>
                        </div>
                    </td>
                    <td class="col-fee">
                        <span class="fee-badge ${pool.feeClass || ''}">${feePct}</span>
                    </td>
                    <td class="col-liquidity">
                        <div class="liquidity-cell">
                            <div class="liquidity-bar" style="width: ${Math.min(100, (pool.liquidity / 1000000))}%"></div>
                            <span class="liquidity-value">${formatUsd(pool.liquidity)}</span>
                        </div>
                    </td>
                    <td class="col-volume volume-cell">
                        ${formatUsd(pool.volume24h)}
                    </td>
                    <td class="col-util">
                        <span class="utilization-value ${pool.utilClass || ''}">${formatUtilization(pool.utilization)}</span>
                    </td>
                    <td class="col-apr apr-cell">
                        <span class="apr-value ${pool.aprClass || ''}">${pool.apr.toFixed(2)}%</span>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function renderAllSections() {
            CONFIG.SECTIONS.forEach(s => renderSection(s.id));
        }

        function initUI() {
            const grid = document.getElementById('dashboard-grid');
            const wrapper = document.getElementById('stablecoin-section-wrapper');
            
            grid.innerHTML = '';
            wrapper.innerHTML = '';

            CONFIG.SECTIONS.forEach(section => {
                const html = `
                <section id="section-${section.id}" class="pair-section ${section.full ? 'full-width' : ''}">
                    <div class="section-overlay" id="overlay-${section.id}">
                        <div class="spinner"></div>
                        <div class="section-overlay-text">Loading data...</div>
                    </div>
                    <div class="section-header">
                        <div class="section-title">${section.title}</div>
                        <div class="section-controls">
                             <span class="pool-count">0 pools</span>
                             <div class="timeframe-toggle">
                                <button class="tf-btn active" onclick="changeTimeframe('${section.id}', '24h')">24h</button>
                                <button class="tf-btn" onclick="changeTimeframe('${section.id}', '7d')">7d</button>
                            </div>
                        </div>
                    </div>
                    <div class="section-content">
                        <div class="table-container">
                            <table class="pool-table">
                                <thead>
                                    <tr>
                                        <th class="col-chain">Chain</th>
                                        <th class="col-protocol">Protocol</th>
                                        <th class="col-pool">Pair</th>
                                        <th class="col-fee">Fee</th>
                                        <th class="col-liquidity" onclick="toggleSort('${section.id}', 'liquidity')">Liquidity</th>
                                        <th class="col-volume" onclick="toggleSort('${section.id}', 'volume24h')">Vol 24h</th>
                                        <th class="col-util" onclick="toggleSort('${section.id}', 'utilization')">Util %</th>
                                        <th class="col-apr" onclick="toggleSort('${section.id}', 'apr')">APR</th>
                                    </tr>
                                </thead>
                                <tbody id="list-${section.id}"></tbody>
                            </table>
                            <div id="nodata-${section.id}" class="no-data hidden">No pools found.</div>
                        </div>
                    </div>
                </section>
                `;

                if (section.full) {
                    wrapper.insertAdjacentHTML('beforeend', html);
                } else {
                    grid.insertAdjacentHTML('beforeend', html);
                }
            });
        }

        window.toggleSort = function(sectionId, field) {
            const s = state.sections[sectionId];
            if (s.sortField === field) {
                s.sortDir = s.sortDir === 'desc' ? 'asc' : 'desc';
            } else {
                s.sortField = field;
                s.sortDir = 'desc';
            }
            renderSection(sectionId);
        };

        window.changeTimeframe = function(sectionId, tf) {
            // Currently UI only, 7d logic requires historical API calls which were omitted for simplicity/performance in this specific single-file extract.
            // The original logic fetched historical data. We will keep 24h as primary active state.
            const container = document.getElementById(`section-${sectionId}`);
            const btns = container.querySelectorAll('.tf-btn');
            btns.forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            log(`Timeframe changed to ${tf} for ${sectionId}. (Showing 24h data)`, 'info');
        };

        async function fetchData() {
            if (state.isLoading) return;
            state.isLoading = true;
            updateHeaderStatus('Fetching data...', 'info', true);
            updateProgress(5);

            // Clear existing
            CONFIG.SECTIONS.forEach(s => {
                state.sections[s.id].pools = [];
            });

            const allPromises = [];

            // 1. GeckoTerminal Sections (BTC/Stable, ETH/Stable, Stable/Stable)
            const geckoSections = CONFIG.SECTIONS.filter(s => s.source === 'gecko');
            
            for (const section of geckoSections) {
                const queries = CONFIG.SEARCHES[section.id] || [];
                if (!queries.length) continue;

                state.sections[section.id].isLoading = true;
                renderSection(section.id);

                for (const network of CONFIG.NETWORKS.GECKO) {
                    const api = new GeckoTerminalSource(network);
                    for (const q of queries) {
                        const promise = (async () => {
                            const pools = await api.searchPools(q);
                            pools.forEach(p => {
                                if (!state.pools.has(p.id)) {
                                    calculateMetrics(p);
                                    state.pools.set(p.id, p);
                                    // Assign to section
                                    // Simple check: does it match the section intent?
                                    // Relying on the search query to be accurate enough.
                                    state.sections[section.id].pools.push(p);
                                }
                            });
                        })();
                        allPromises.push(promise);
                    }
                }
            }

            // 2. DexScreener Sections (SOL/Stable)
            const solSection = CONFIG.SECTIONS.find(s => s.id === 'sol-stable');
            if (solSection) {
                state.sections['sol-stable'].isLoading = true;
                renderSection('sol-stable');
                const api = new DexScreenerSource();
                for (const q of CONFIG.DEXSCREENER_QUERIES) {
                    const promise = (async () => {
                        const pools = await api.searchPools(q);
                        pools.forEach(p => {
                            if (!state.pools.has(p.id)) {
                                calculateMetrics(p);
                                state.pools.set(p.id, p);
                                state.sections['sol-stable'].pools.push(p);
                            }
                        });
                    })();
                    allPromises.push(promise);
                }
            }

            // Wait for all
            let completed = 0;
            for (const p of allPromises) {
                p.then(() => {
                    completed++;
                    updateProgress(5 + (completed / allPromises.length) * 90);
                }).catch(e => log(e.message, 'error'));
            }

            await Promise.all(allPromises);

            // Finalize
            CONFIG.SECTIONS.forEach(s => {
                state.sections[s.id].isLoading = false;
                // Sort default
                state.sections[s.id].pools = sortPools(state.sections[s.id].pools, 'utilization', 'desc');
                
                // Update pool count in UI
                const secEl = document.getElementById(`section-${s.id}`);
                if(secEl) {
                    const countEl = secEl.querySelector('.pool-count');
                    if(countEl) countEl.textContent = `${state.sections[s.id].pools.length} pools`;
                }
            });

            updateProgress(100);
            renderAllSections();
            updateHeaderStatus('Updated', 'success');
            document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            state.isLoading = false;
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initUI();
            fetchData();

            document.getElementById('refresh-btn').addEventListener('click', fetchData);
            
            document.getElementById('debug-toggle').addEventListener('click', () => {
                document.getElementById('debug-section').classList.toggle('hidden');
            });
            
            document.getElementById('clear-debug').addEventListener('click', () => {
                state.debugLogs = [];
                renderDebugLog();
            });
        });

    })();
    </script>
</body>
</html>